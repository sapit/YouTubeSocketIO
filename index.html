<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
      div.title {
          text-align: center;
          margin-top:10px;
          margin-bottom:10px;
      }
    </style>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  </head>
  <body class="">
      <div class="container">
        <div class="col-md-12">
          <div id="player"></div>
        </div>
        <div class="col-md-12">
          <div class="col-md-8">
            <input id="search" class="form-control"/>
          </div>
          <button id="searchButton" class="btn btn-primary col-md-4">Search</button>
        </div>
        <div class="col-md-6 title">
            Search results:
        </div>
        <div class="col-md-6 title">
            Queue
        </div>
        <ul id="resultsBox" class="list-group col-md-6">
        </ul>
        <ul id="queueBox" class="list-group col-md-6">
        </ul>
    </div>


    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var socket = io();
      $('form').submit(function(){
        socket.emit('chat message', $('#m').val());
        $('#m').val('');
        return false;
      });
      socket.on('chat message', function(msg){
        $('#messages').append($('<li>').text(msg));
      });
    // </script>
    // <script>
        var videoID;
        var queue=[];
        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        videoID = sessionStorage.getItem("key");

        var onYouTubeIframeAPIReady = function(){
            player = new YT.Player('player', {
                height: '315',
                width: '560',
                videoId: videoID,
                events: {
                    'onReady': onPlayerReady
                }
            });
        }

        //The API will call this function when the video player is ready.
        function onPlayerReady(event) {
            event.target.playVideo();
            console.log(videoID);
            player.addEventListener('onStateChange', function(e) {
                 console.log('State is:', e.data);
                 if(e.data==0)
                 {
                    var id = queue.shift();
                    // console.log(id);
                    if(id)
                    {
                        player.loadVideoById(id);
                        $("div[data-id=" + id + "]").hide();
                    }
                    else
                    {
                        id=player.getVideoData()['video_id'];
                        var theAPIrecommendations = "https://www.googleapis.com/youtube/v3/search?part=snippet&relatedToVideoId="+id+"&type=video&maxResults=15&key=AIzaSyA9ej5NSrEqzex76U_xE3PPJlb2rELrW9M";

                        $.getJSON(theAPIrecommendations, function(data){
                            player.loadVideoById(data.items[0].id.videoId);
                        })
                    }
                 }
             });
        }

        $("#searchButton").on("click", function(){
            searchQuery();
        })
        socket.on("songChanged", function(id){
            if(player.getPlayerState() == -1)
               player.loadVideoById(id);
            else if($.inArray(id, queue)==-1)
            {
                // $.inArray(id, queue);
                queue.push(id);

                var videoIdAPI = "https://www.googleapis.com/youtube/v3/videos?id="+id+"&part=snippet&key=AIzaSyA9ej5NSrEqzex76U_xE3PPJlb2rELrW9M";
                // console.log(videoData.items);
                $.getJSON(videoIdAPI, function(data){
                    var image = '<div class="col-md-3"> <img class="img-responsive" src="' + data.items[0].snippet.thumbnails.default.url + '"> </div>';
                    // var image = "";
                    // $("#queueBox").append('<li class="list-group-item">'+ image + '</li>');
                    $("#queueBox").append('<li class="list-group-item clearfix">'+ image + '<div class="col-md-9" data-id="' +data.items[0].id+ '">' + data.items[0].snippet.title +'</div></li>');
                    console.log(data.items[0]);
                })
                
                // console.log("dsdsa");
                
            }
            // player.cueVideoById(id);
            // setTimeout(function(){
            //   console.log(player.getDuration());
            // },5000);
            // console.log(https://gdata.youtube.com/feeds/api/videos/Xr8vUTm64h0/related?v=2&fields=entry(id));

            // $.get("https://gdata.youtube.com/feeds/api/videos/Xr8vUTm64h0/related?v=2&fields=entry(" + id + ')', function(data){
            // $.get("https://gdata.youtube.com/feeds/api/standardfeeds/most_popular", function(data){
            //   console.log(data);
            // });

            
        });

        $(document).ready(function(){
            $("ul").on("click","li", function(){
                // console.log($(this));
                // console.log($(this).children('a').attr("data-id"));
                // console.log(socket);

                // e.preventDefault();
                let id = $(this).find('a').attr("data-id");
                // player.loadVideoById(id);
                socket.emit("songChange",id);
            })
        });
        function searchQuery() {
            //Declare selectors
            var queryContainer = $('#resultsBox');
            var searchBox = $('#search');

            //Declare variables from input elements :)
            var search = $(searchBox).val();
            var checker = search.length;

            //Check if the input is empty string
            if(search!=''){
                //Declare the YoutubeAPI link with youtube APIkey
                var theAPI = "https://www.googleapis.com/youtube/v3/search?part=snippet&q="+search+"&maxResults=15&key=AIzaSyA9ej5NSrEqzex76U_xE3PPJlb2rELrW9M";

                //Get JSON string from YoutubeAPI link
                $.getJSON(theAPI, function(data){

                    //Append 5 titles to the div
                    for(var i=0; i<=20; ++i){
                        //Using the kind property from YoutubeAPI determine is it a profile or video
                        // console.log(data.items);
                        var image = '<div class="col-md-3"> <img class="img-responsive" src="' + data.items[i].snippet.thumbnails.default.url + '"></div>';
                        if(data.items[i].id.kind === 'youtube#video'){
                            $(queryContainer).append('<li class="result list-group-item clearfix">'+ image + '<div class="col-md-9"><a href="#" data-id="' +data.items[i].id.videoId+'">' +data.items[i].snippet.title+'</a></div></li>');
                        
                        }
                    }
                    $('div.search-box a').on('click', function(){

                        $('div#player-box').empty();
                        $('div#player-box').append('<div id="player"></div>');
                        sessionStorage.setItem('key', $(this).data("id"));

                        onYouTubeIframeAPIReady();

                    });
                });

                //Check if the input value is changing, if it does cleares the previous output
                if(checker){
                    $(queryContainer).empty();
                }
            }else{
                $(queryContainer).empty();
                return false;
            }
        }
    </script>



  </body>
</html>
