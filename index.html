<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  </head>
  <body class="container">
      <div class="row">
        <div id="player"></div>
        <input id="search" class="form-control col-md-4"/>
        <button id="searchButton" class="btn btn-primary ">Search</button>
        <ul id="searchBox" class="list-group">
        </ul>
    </div>


    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var socket = io();
      $('form').submit(function(){
        socket.emit('chat message', $('#m').val());
        $('#m').val('');
        return false;
      });
      socket.on('chat message', function(msg){
        $('#messages').append($('<li>').text(msg));
      });
    // </script>
    // <script>
        var videoID;

        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        videoID = sessionStorage.getItem("key");

        var onYouTubeIframeAPIReady = function(){
            player = new YT.Player('player', {
                height: '315',
                width: '560',
                videoId: videoID,
                events: {
                    'onReady': onPlayerReady
                }
            });
        }

        //The API will call this function when the video player is ready.
        function onPlayerReady(event) {
            event.target.playVideo();
                console.log(videoID);
        }

        $("#searchButton").on("click", function(){
            searchQuery();
        })
        socket.on("songChanged", function(id){
            console.log("HUII");
            player.loadVideoById(id);
        });
        
        $(document).ready(function(){
            $("ul").on("click","li", function(){
                console.log($(this));
                console.log($(this).children('a').attr("data-id"));
                console.log(socket);
                // e.preventDefault();
                let id = $(this).children('a').attr("data-id");
                // player.loadVideoById(id);
                socket.emit("songChange",id);
            })
        });
        function searchQuery() {
            //Declare selectors
            var queryContainer = $('#searchBox');
            var searchBox = $('#search');

            //Declare variables from input elements :)
            var search = $(searchBox).val();
            var checker = search.length;

            //Check if the input is empty string
            if(search!=''){
                //Declare the YoutubeAPI link with youtube APIkey
                var theAPI = "https://www.googleapis.com/youtube/v3/search?part=snippet&q="+search+"&maxResults=15&key=AIzaSyA9ej5NSrEqzex76U_xE3PPJlb2rELrW9M";

                //Get JSON string from YoutubeAPI link
                $.getJSON(theAPI, function(data){

                    //Append 5 titles to the div
                    for(var i=0; i<=20; ++i){
                        //Using the kind property from YoutubeAPI determine is it a profile or video
                        // console.log(data.items);
                        if(data.items[i].id.kind === 'youtube#video'){
                            $(queryContainer).append('<li class="result list-group-item"><a href="#" data-id="' +data.items[i].id.videoId+'">' +data.items[i].snippet.title+'</a></li>');
                        }else if(data.items[i].id.kind === 'youtube#channel'){
                            $(queryContainer).append('<li><a href="https://www.youtube.com/user/'+data.items[i].snippet.title+'">' +data.items[i].snippet.title+'</a></li>')
                        }
                    }
                    $('div.search-box a').on('click', function(){

                        $('div#player-box').empty();
                        $('div#player-box').append('<div id="player"></div>');
                        sessionStorage.setItem('key', $(this).data("id"));

                        onYouTubeIframeAPIReady();

                    });
                });

                //Check if the input value is changing, if it does cleares the previous output
                if(checker){
                    $(queryContainer).empty();
                }

            }else{
                $(queryContainer).empty();
                return false;
            }
        }
    </script>



  </body>
</html>
